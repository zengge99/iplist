name: Update IP List

on:
  workflow_dispatch:  # 允许手动触发
  schedule:
    - cron: '0 */6 * * *'  # 每6小时自动运行一次

jobs:
  update-ip-list:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # 获取完整提交历史

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Extract and save IP list
      run: |
        # 安装必要的依赖
        pip install requests urllib3
        
        # 创建Python脚本提取IP列表
        cat << 'EOF' > extract_ips.py
        import requests
        import base64
        import re
        from urllib.parse import unquote

        # 获取配置
        url = "https://auto.858666.xyz/auto"
        response = requests.get(url)
        response.raise_for_status()
        
        # 解码Base64
        decoded = base64.b64decode(response.text).decode('utf-8')
        
        # 提取服务器信息
        pattern = r'vless://[^@]*@([^:/]+)[:/]*(\d+)[^#]*#([^\s]+)'
        matches = re.findall(pattern, decoded)
        
        # 写入文件
        with open("iplist.txt", "w") as f:
            for host, port, remark in matches:
                remark = unquote(remark)  # URL解码
                f.write(f"{host}:{port}#{remark}\n")
        EOF

        # 运行Python脚本
        python extract_ips.py

    - name: Commit changes
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        
        if git diff --quiet --exit-code; then
          echo "没有变化需要提交"
        else
          git add iplist.txt
          git commit -m "自动更新IP列表 [skip ci]"
          git push
        fi
